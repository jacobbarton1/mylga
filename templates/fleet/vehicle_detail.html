{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Unit {{ vehicle.unit_number|floatformat:"0" }} — {{ vehicle.registration }}</h2>
  <div>
    <a href="{% url 'fleet:defect_create_for_vehicle' vehicle.pk %}" class="btn btn-warning btn-sm me-2">
      Report defect
    </a>
    <a href="{% url 'fleet:maintenance_create_for_vehicle' vehicle.pk %}" class="btn btn-success btn-sm">
      Add maintenance
    </a>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-6">
    <h5>Details</h5>
    <dl class="row">
      <dt class="col-sm-4">Category</dt>
      <dd class="col-sm-8">{{ vehicle.get_category_display }}</dd>
      <dt class="col-sm-4">Make / Model</dt>
      <dd class="col-sm-8">{{ vehicle.make }} {{ vehicle.model }} ({{ vehicle.year }})</dd>
      <dt class="col-sm-4">Department</dt>
      <dd class="col-sm-8">{{ vehicle.department }}</dd>
      <dt class="col-sm-4">Notes</dt>
      <dd class="col-sm-8">{{ vehicle.notes|default:"—" }}</dd>
    </dl>
  </div>
</div>

<div class="row">
  <div class="col-md-6 mb-4">
    <h5>Open defects</h5>
    {% with open_defects=defects|dictsortreversed:"reported_at" %}
    {% if defects %}
    <ul class="list-group">
      {% for d in defects %}
      <li class="list-group-item position-relative">
        <div class="fw-bold">{{ d.get_severity_display }} — {{ d.reported_at|date:"Y-m-d H:i" }}</div>
        <div>{{ d.description }}</div>
        <div class="small text-muted">Status: {{ d.get_status_display }}</div>
        <a href="{% url 'fleet:defect_detail' d.pk %}" class="stretched-link"></a>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p class="text-muted">No defects recorded.</p>
    {% endif %}
    {% endwith %}
  </div>
  <div class="col-md-6 mb-4">
    <h5>Maintenance history</h5>
    {% if maintenance_records %}
    <ul class="list-group">
      {% for m in maintenance_records %}
      <li class="list-group-item position-relative">
        <div class="fw-bold">{{ m.date|date:"Y-m-d" }} — {{ m.description }}</div>
        {% if m.odometer_km %}
        <div class="small text-muted">Odometer: {{ m.odometer_km }} km</div>
        {% endif %}
        {% if m.cost %}
        <div class="small text-muted">Cost: ${{ m.cost }}</div>
        {% endif %}
        <div class="small text-muted">
          Submitted by: {{ m.submitted_by.get_full_name|default:m.submitted_by|default:"System" }}
          {% if m.defect_report %}
          · Linked defect status: {{ m.defect_report.get_status_display }}
          {% endif %}
        </div>
        {% with evidence_count=m.evidence_documents.count %}
        {% if evidence_count %}
        <div class="small text-muted">{{ evidence_count }} supporting document{{ evidence_count|pluralize }}</div>
        {% endif %}
        {% endwith %}
        <a href="{% url 'fleet:maintenance_detail' m.pk %}" class="stretched-link"></a>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p class="text-muted">No maintenance records yet.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
